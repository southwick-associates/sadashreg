---
title: "Prepare a Tabeau Input example for states processing their own data"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

## Overview

We are also coordinating with "state-processed" agencies, where the agency (e.g., TX) will produce a set of summary statistics that can be imported into the Tableau National/Regional dashboard. The input data needed is different of the input for individual state dashboards:

Note: Knitting this file doesn't really work right now (but it can be run interactively). I didn't care enough about this to troubleshoot the issue.

**More Limited Scope**:

- Filtered to exclude youths (< 18) and seniors (> 64)
- Only hunting & fishing (i.e., 2 permissions)
- No monthly breakouts
- No county breakouts

**Changes**:

- churn & participation rate displayed on a 0 to 100 point scale (instead of 0 to 1)
- calendar year of purchase for defining license year
- additional fields for enabling nat/reg functionality (region, aggregation, value type)

```{r setup, message=FALSE}
library(tidyverse)
knitr::opts_chunk$set(comment = NA)
```

## Run Results

R `by-priv-results.Rmd` for fish/hunt and stack the output into a csv

```{r, message=FALSE}
### SETUP
qtr <- 4
all_yrs <- "2008:2017"

run_dash <- function(
    priv_nm, priv_ref = "NONE", yrs = all_yrs, res_filter = "NONE", res_type = "NONE", 
    quarter = 4, state = "OR",
    path = "by-priv-results.Rmd" # location of Rmd file
) {
    output_file = paste0("log/by-priv-results-", priv_nm, quarter, ".html")
    rmarkdown::render(
        path, params = list(
            priv_nm = priv_nm, priv_ref = priv_ref, quarter = quarter, 
            res_filter = res_filter, res_type = res_type, yrs = yrs, state = state
        ),  
        output_file = output_file
    )
}

### Create Tables
run_dash("hunt")
run_dash("fish")
```

```{r}
### Stack

# load
rdata_dir <- "../../data/dashboard-results"
files <- list.files(rdata_dir, pattern = "\\.RDATA$")
file_paths <- file.path(rdata_dir, files)
dat <- list()
for (i in seq_along(file_paths)) {
    load(file_paths[i])
    dat[[i]] <- out_tbl
}
dat <- bind_rows(dat)

glimpse(dat)
```

### Modifications

### Exclude Part. Rate

States aren't expected to include this metric

```{r}
dashout <- dat %>%
    filter(metric != "participation rate")
```


### Churn Scale

Placing churn and rate on 100 point scale

```{r}
dashout <- dashout %>%
    mutate(value = ifelse(metric %in% c("churn", "participation rate"), value * 100, value))

dashout %>%
    group_by(metric) %>%
    summarise(mean(value), max(value), min(value))
```


## Output to CSV

```{r}
# county not needed
dashout <- dashout %>%
    filter(segment != "county")

# reordering cols & some renaming
dashout <- dashout %>%
    filter(year <= 2017) %>%
    mutate(
        metric = ifelse(metric == "participants - recruited", "recruits", metric),
        timeframe = "full-year"
    ) %>%
    select(timeframe, group, segment, category, year, metric, value)

write_csv(dashout, "../../data/dashboard-results/summary-data-example.csv")
```


```{r}
sessionInfo()
```
