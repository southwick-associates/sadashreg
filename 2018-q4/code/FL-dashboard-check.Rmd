---
title: "Checking the dashboard data supplied by NE"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: hide
---

```{r setup, message=FALSE}
library(tidyverse)
library(readxl)
knitr::opts_chunk$set(comment = NA)
```

## Overview

- there is something wrong with churn in 2018 across the board
- there's a big data artifact in 2015 hunting, which appears to be restricted to people in their 40s or above (seemingly more pronounced for older hunters)
    + shows up a little bit in fish/all_sports as well

### TODO: mid-year

Are there issues in the mid-year results which also require attention?

## Load

```{r, message=FALSE}
st <- "FL"
f <- "../../data/FL/FL_dashboard_2018FullYear_Summary.csv.xlsx"
x <- read_excel(f)
names(x) <- tolower(names(x))

x <- mutate(x, metric = ifelse(metric == "Pariticipants", "Participants", metric))
x <- filter(x, year != 2019)

glimpse(x)
```

## Check Completeness

```{r}
count(x, group, metric) %>% spread(metric, n)
```

```{r}
count(x, metric, year) %>% spread(year, n)
```

```{r}
count(x, segment, category)
```

## Check Total Values

- Big jump in hunting participants in 2015 (probably an artifact). Would need to review the FL lic analysis project to really find out what might be causing it (2015 is for sure an outlier, which shows up in recruitment as well)

- Churn drops in 2018 don't seem realistic

```{r, fig.height = 6}
filter(x, segment == "All") %>%
    select(group, year, metric, value) %>%
    ggplot(aes(year, value)) +
    geom_col() +
    facet_wrap(group ~ metric, scales = "free")
```

## Check Segment Sums

These just appear to have not been scaled. I can fix that.

```{r, message = FALSE}
tot <- filter(x, segment == "All", metric != "churn") %>%
    select(group, year, metric, value)

seg <- filter(x, segment != "All", metric != "churn") %>%
    group_by(group, year, metric, segment) %>%
    summarise(value.seg = sum(value))

full_join(tot, seg) %>%
    mutate(pct_diff = (value.seg - value) / value * 100) %>%
    filter(abs(pct_diff) > 0.01) %>%
    knitr::kable()
```

## Check By-Segment Values

- The 2015 data artifact is in full view here when look by age: 55-64 age category (and 45-54 to a lesser degree)

```{r}
filter(x, segment == "age", metric == "Participants") %>%
    ggplot(aes(year, value)) +
    geom_col() +
    facet_grid(group ~ category, scales = "free")

filter(x, segment == "age", metric == "Recruits") %>%
    ggplot(aes(year, value)) +
    geom_col() +
    facet_grid(group ~ category, scales = "free")

filter(x, segment == "age", metric == "churn") %>%
    ggplot(aes(year, value)) +
    geom_col() +
    facet_grid(group ~ category, scales = "free")

filter(x, segment == "gender") %>%
    ggplot(aes(year, value, fill = category)) +
    geom_col(position = position_dodge()) +
    facet_wrap(group ~ metric, scales = "free")

filter(x, segment == "Residency") %>%
    ggplot(aes(year, value, fill = category)) +
    geom_col(position = position_dodge()) +
    facet_wrap(group ~ metric, scales = "free")
```
