---
title: "Pull a sample db (license/history) from MO, originally for Jody Simoes at MA"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

```{r setup, message=FALSE}
library(tidyverse)
library(DBI)
library(salic)
knitr::opts_chunk$set(comment = NA)
```

## Load

- A sample of customers (who fish or hunt)

```{r}
f <- "E:/SA/Data-production/Data-Dashboards/MO/history.sqlite3"
con <- dbConnect(RSQLite::SQLite(), f)
fish <- tbl(con, "fish") %>%
    select(cust_id:duration_run, bought:R3) %>%
    collect()

hunt <- tbl(con, "hunt") %>%
    select(cust_id:duration_run, bought:R3) %>%
    collect()

cust_sample <- bind_rows(select(fish, cust_id), select(hunt, cust_id)) %>%
    distinct() %>%
    sample_n(100)
rm(fish, hunt)
dbDisconnect(con)
```

- look at sales by lic type & modify some to be lifetime & multi-year
- run license history (see example code, should be fairly simple)

```{r}
f <- "E:/SA/Data-production/Data-Dashboards/MO/license.sqlite3"
con <- dbConnect(RSQLite::SQLite(), f)
cust <- tbl(con, "cust") %>%
    select(cust_id, sex:cust_res) %>%
    filter(cust_id %in% cust_sample$cust_id) %>%
    collect()

lic <- dbReadTable(con, "lic") %>%
    select(lic_id:type, duration, lic_res = res) %>%
    # filter(type != "other") %>%
    mutate(
        duration = ifelse(is.na(duration), 1, duration),
        type = ifelse(type == "trap", "hunt", type)    
    )

sale <- tbl(con, "sale") %>%
    select(cust_id, lic_id, year, dot, sale_res = res) %>%
    filter(cust_id %in% cust_sample$cust_id) %>%
    collect()
    
dbDisconnect(con)
```

- Modifications to serve as a more complete example
- Also simplifies license table, and lowers sample to 90 customers

```{r}
lic_other <- filter(lic, type == "other") # don't want these in sales
sale <- anti_join(sale, lic_other, by = "lic_id")
lic <- semi_join(lic, sale, by = "lic_id")

# add some artificial modifications to license types
lic %>%
    mutate(description = tolower(description)) %>%
    write_excel_csv("../../out/0-documentation/work/licout.csv")

lic <- readxl::read_excel("../../out/0-documentation/work/licin.xlsx")

# some extra license type filtering (for simplification)
x <- sale %>%
    left_join(lic) %>%
    count(lic_id, description, duration, type)
drop_lic <- filter(x, n < 10)

sale <- sale %>% anti_join(drop_lic, by = "lic_id")
cust <- semi_join(cust, sale, by = "cust_id")
lic <- semi_join(lic, sale, by = "lic_id")
```

Simulate some multi-year & lifetimes (4 customers)

```{r}
newlic <- tibble(
    lic_id = 1:2, 
    description = c("lifetime", "3 year"),
    type = c("combo", "combo"),
    duration = c(99,3),
    lic_res = c("1","1")
)
lic <- bind_rows(newlic, lic)
newsale <- readxl::read_excel("../../out/0-documentation/work/newsale.xlsx")
sale <- bind_rows(newsale, sale)
newcust <- readxl::read_excel("../../out/0-documentation/work/newcust.xlsx")
cust <- bind_rows(newcust, cust)

unique(cust$cust_id)
```

## Build license history

Hunting

```{r}
sale_unranked <- lic %>%
    filter(type %in% c("combo", "hunt")) %>%
    select(lic_id, duration) %>%
    left_join(sale) %>%
    select(cust_id, year, duration, res = sale_res)
sale_ranked <- rank_sale(sale_unranked)

hunt <- sale_ranked %>%
    make_lic_history(2007:2017, carry_vars = "res")

hunt <- identify_R3(hunt, 2007:2017)
hunt <- identify_lapse(hunt, 2007:2017)

# sample a few customers
hunt %>%
    select(cust_id, year, res, bought, duration, duration_run, lag_duration_run, R3, lapse) %>%
    check_history_samp() %>% DT::datatable()
```

Fishing

```{r}
sale_unranked <- lic %>%
    filter(type %in% c("combo", "fish")) %>%
    select(lic_id, duration) %>%
    left_join(sale) %>%
    select(cust_id, year, duration, res = sale_res)
sale_ranked <- rank_sale(sale_unranked)

fish <- sale_ranked %>%
    make_lic_history(2007:2017, carry_vars = "res")

fish <- identify_R3(fish, 2007:2017)
fish <- identify_lapse(fish, 2007:2017)

# sample a few customers
fish %>%
    select(cust_id, year, res, bought, duration, duration_run, lag_duration_run, R3, lapse) %>%
    check_history_samp() %>% DT::datatable()
```


## Write to CSV

```{r}
write_excel_csv(fish, "../../out/0-documentation/fish.csv")
write_excel_csv(hunt, "../../out/0-documentation/hunt.csv")

write_excel_csv(cust, "../../out/0-documentation/cust.csv")
write_excel_csv(lic, "../../out/0-documentation/lic.csv")
write_excel_csv(sale, "../../out/0-documentation/sale.csv")

```


```{r}
sessionInfo()
```
